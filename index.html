<!DOCTYPE html>
<html>
<head>
  <title>FEELCYCLE予約チェック【デバッグ用】</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    #submitBtn {
      width: 90vw;
      max-width: 400px;
      height: 56px;
      font-size: 1.3rem;
      background: #228be6;
      color: #fff;
      border: none;
      border-radius: 12px;
      margin: 0 auto;
      display: block;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: background 0.2s;
    }
    #submitBtn:active {
      background: #1864ab;
    }
    form {
      max-width: 420px;
      margin: 0 auto;
      padding-bottom: 100px;
    }
    @media (max-width: 600px) {
      #submitBtn {
        position: fixed;
        left: 5vw;
        right: 5vw;
        bottom: 30px;
        z-index: 100;
        margin: 0;
      }
      form {
        padding-bottom: 120px;
      }
    }
    #debug-info {
      background: #f3f3f3;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px 15px;
      margin: 20px auto;
      max-width: 440px;
      color: #222;
      font-size: 0.97rem;
      line-height: 1.7;
      word-break: break-all;
    }
    #debug-info strong { color: #228be6; }
  </style>
</head>
<body>
  <h2>FEELCYCLE レッスン登録【デバッグ用】</h2>
  <form id="reserveForm">
    <label>スタジオ:<br>
      <select id="studio" required>
        <option value="">選択してください</option>
        <option value="銀座">銀座</option>
        <option value="銀座京橋">銀座京橋</option>
        <option value="汐留">汐留</option>
        <option value="吉祥寺">吉祥寺</option>
        <option value="池袋">池袋</option>
        <option value="自由が丘">自由が丘</option>
        <option value="渋谷">渋谷</option>
        <option value="五反田">五反田</option>
        <option value="新宿">新宿</option>
        <option value="中目黒">中目黒</option>
        <option value="上野">上野</option>
        <option value="川崎">川崎</option>
        <option value="横浜">横浜</option>
        <option value="上大岡">上大岡</option>
        <option value="横須賀中央">横須賀中央</option>
        <option value="海浜幕張">海浜幕張</option>
        <option value="船橋">船橋</option>
        <option value="町田">町田</option>
        <option value="立川">立川</option>
        <option value="多摩センター">多摩センター</option>
        <option value="武蔵小杉">武蔵小杉</option>
        <option value="大宮">大宮</option>
        <option value="越谷">越谷</option>
        <option value="柏">柏</option>
      </select>
    </label>
    <br><br>
    <label>日付:<br>
      <input type="text" id="datePicker" placeholder="日付を選択" required>
    </label>
    <br><br>
    <label>時間:<br>
      <select id="timePicker" required>
        <option value="">選択してください</option>
        <option value="07:00">07:00</option>
        <option value="07:15">07:15</option>
        <option value="07:30">07:30</option>
        <option value="07:45">07:45</option>
        <option value="08:00">08:00</option>
        <option value="08:15">08:15</option>
        <option value="08:30">08:30</option>
        <option value="08:45">08:45</option>
        <option value="09:00">09:00</option>
        <option value="09:15">09:15</option>
        <option value="09:30">09:30</option>
        <option value="09:45">09:45</option>
        <option value="10:00">10:00</option>
        <option value="10:15">10:15</option>
        <option value="10:30">10:30</option>
        <option value="10:45">10:45</option>
        <option value="11:00">11:00</option>
        <option value="11:15">11:15</option>
        <option value="11:30">11:30</option>
        <option value="11:45">11:45</option>
        <option value="12:00">12:00</option>
        <option value="12:15">12:15</option>
        <option value="12:30">12:30</option>
        <option value="12:45">12:45</option>
        <option value="13:00">13:00</option>
        <option value="13:15">13:15</option>
        <option value="13:30">13:30</option>
        <option value="13:45">13:45</option>
        <option value="14:00">14:00</option>
        <option value="14:15">14:15</option>
        <option value="14:30">14:30</option>
        <option value="14:45">14:45</option>
        <option value="15:00">15:00</option>
        <option value="15:15">15:15</option>
        <option value="15:30">15:30</option>
        <option value="15:45">15:45</option>
        <option value="16:00">16:00</option>
        <option value="16:15">16:15</option>
        <option value="16:30">16:30</option>
        <option value="16:45">16:45</option>
        <option value="17:00">17:00</option>
        <option value="17:15">17:15</option>
        <option value="17:30">17:30</option>
        <option value="17:45">17:45</option>
        <option value="18:00">18:00</option>
        <option value="18:15">18:15</option>
        <option value="18:30">18:30</option>
        <option value="18:45">18:45</option>
        <option value="19:00">19:00</option>
        <option value="19:15">19:15</option>
        <option value="19:30">19:30</option>
        <option value="19:45">19:45</option>
        <option value="20:00">20:00</option>
        <option value="20:15">20:15</option>
        <option value="20:30">20:30</option>
        <option value="20:45">20:45</option>
        <option value="21:00">21:00</option>
        <option value="21:15">21:15</option>
        <option value="21:30">21:30</option>
      </select>
    </label>
    <br><br>
    <button type="submit" id="submitBtn">登録</button>
  </form>

  <div id="debug-info">
    <strong>デバッグ情報：</strong>
    <div id="debug-msg">LIFF初期化待ち...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // デバッグフラグ
    const DEBUG = true;
    // flatpickrでMM/DD形式の入力
    flatpickr("#datePicker", {
      dateFormat: "m/d",
      allowInput: true,
    });

    let userId = "";
    let liffReady = false;
    const debugMsg = msg => {
      if (DEBUG && document.getElementById('debug-msg')) {
        document.getElementById('debug-msg').innerText = msg;
      }
    };

    window.onload = function () {
      debugMsg('LIFF初期化中...');
      liff.init({
        liffId: "2007455412-YP5jEbzK" // あなたのLIFF IDに
      }).then(() => {
        liffReady = true;
        debugMsg("LIFF初期化完了。ログイン状態チェック中…");
        if (!liff.isLoggedIn()) {
          debugMsg("未ログインのためログインへリダイレクト");
          liff.login();
        } else {
          liff.getProfile().then(function (profile) {
            userId = profile.userId;
            debugMsg("userId取得: " + userId);
          }).catch(function (err) {
            debugMsg("userId取得失敗: " + err);
          });
        }
      }).catch(function (err) {
        debugMsg('LIFF初期化失敗: ' + err);
      });
    }

    document.getElementById('reserveForm').onsubmit = async function(e) {
      e.preventDefault();
      if (!liffReady) {
        alert('LIFF未初期化。');
        debugMsg('LIFF未初期化。');
        return;
      }
      const studio = document.getElementById('studio').value;
      const date = document.getElementById('datePicker').value;
      const time = document.getElementById('timePicker').value;
      if (!userId) {
        alert('userId取得失敗。LINEアプリから開いてください。');
        debugMsg('userId未取得。');
        return;
      }
      // 送信内容も画面に表示
      debugMsg(`送信内容: 
  studio: ${studio}
  date: ${date}
  time: ${time}
  userId: ${userId}
  ---- 送信中… ----`);
      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbwzSOu2UWcQdlZ63YJnvLHaM_8MDi-8fsp1up0C_2LtQ2MIjh3ppT2nTIMnQZLTANJcvw/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studio, date, time, userId })
        });
        let msg = `送信完了: status=${res.status}`;
        try {
          const data = await res.text();
          msg += "\nレスポンス: " + data;
        } catch (e) {}
        alert(msg);
        debugMsg(`送信内容:\nstudio: ${studio}\ndate: ${date}\ntime: ${time}\nuserId: ${userId}\n----\n送信完了: status=${res.status}`);
        if (window.liff && window.liff.closeWindow) liff.closeWindow();
      } catch (err) {
        alert("送信失敗: " + err);
        debugMsg("送信失敗: " + err);
      }
    }
  </script>
</body>
</html>
